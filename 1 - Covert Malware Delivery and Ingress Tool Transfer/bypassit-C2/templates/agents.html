<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BypassIT Agents</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .online {
            color: green;
            font-weight: bold;
        }
        .offline {
            color: red;
            font-weight: bold;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .online .status-indicator {
            background-color: green;
        }
        .offline .status-indicator {
            background-color: red;
        }
    </style>
</head>
<body>
    <h1>BypassIT Agents</h1>
    <table>
        <thead>
            <tr>
                <th>Agent ID</th>
                <th>Computer Name</th>
                <th>Status</th>
                <th>Last Checkin</th>
                <th>Command</th>
                <th>Upload File</th>
                <th>Download File</th>
            </tr>
        </thead>
        <tbody id="agent-table-body">
        </tbody>
    </table>

    <script>
        async function fetchAgents() {
            const response = await fetch('/agents_data');
            const agents = await response.json();
            const tableBody = document.getElementById('agent-table-body');
            tableBody.innerHTML = '';

agents.forEach(agent => {
    const row = document.createElement('tr');
    
    const idCell = document.createElement('td');
    idCell.textContent = agent.agent_id;
    row.appendChild(idCell);

    const nameCell = document.createElement('td');
    nameCell.textContent = agent.computer_name;
    row.appendChild(nameCell);

    const statusCell = document.createElement('td');
    const statusIndicator = document.createElement('span');
    statusIndicator.classList.add('status-indicator');
    statusCell.appendChild(statusIndicator);
    const statusText = document.createElement('span');
    statusText.textContent = agent.status;
    statusText.classList.add(agent.status);
    statusCell.appendChild(statusText);
    row.appendChild(statusCell);

    const checkinCell = document.createElement('td');
    checkinCell.textContent = agent.last_checkin;
    row.appendChild(checkinCell);

    const commandCell = document.createElement('td');
    const commandInput = document.createElement('input');
    commandInput.type = 'text';
    commandInput.placeholder = 'Enter command';
    commandCell.appendChild(commandInput);
    const sendButton = document.createElement('button');
    sendButton.textContent = 'Send';
    sendButton.onclick = async () => {
        const command = commandInput.value;
        const response = await fetch('/command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ agent_id: agent.agent_id, command: command }),
        });
        const result = await response.json();
        alert(result.message);
    };
    commandCell.appendChild(sendButton);
    row.appendChild(commandCell);

    const uploadCell = document.createElement('td');
    const uploadInput = document.createElement('input');
    uploadInput.type = 'file';
    uploadInput.onchange = async () => {
        const file = uploadInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
        });
        const result = await response.json();
        alert(result.message);

        // Schedule file transfer command
        const fileTransferResponse = await fetch('/command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ agent_id: agent.agent_id, command: `download_file ${file.name}` }),
        });
        const fileTransferResult = await fileTransferResponse.json();
        alert(fileTransferResult.message);
    };
    uploadCell.appendChild(uploadInput);
    row.appendChild(uploadCell);

    // New download cell
    const downloadCell = document.createElement('td');
    const downloadInput = document.createElement('input');
    downloadInput.type = 'text';
    downloadInput.placeholder = 'Enter file path';
    downloadCell.appendChild(downloadInput);
    const downloadButton = document.createElement('button');
    downloadButton.textContent = 'Download';
    downloadButton.onclick = async () => {
        const filePath = downloadInput.value;
        if (!filePath) {
            alert('Please enter a file path');
            return;
        }
        const response = await fetch('/queue_upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ agent_id: agent.agent_id, filepath: filePath }),
        });
        const result = await response.json();
        alert(result.message);
    };
    downloadCell.appendChild(downloadButton);
    row.appendChild(downloadCell);

    tableBody.appendChild(row);
});


        }

        setInterval(fetchAgents, 10000);
        fetchAgents();
    </script>
</body>
</html>
